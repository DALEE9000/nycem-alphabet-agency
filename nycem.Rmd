---
title: "NYCEM Budget Analysis (RMarkdown)"
author: "David A. Lee"
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    theme: readable
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  fig.align = "center",
  dpi = 300
)

suppressPackageStartupMessages({
  library(tidyverse)
  library(lubridate)
  library(scales)
})
```

### Load data

```{r load-data}
file_path <- "./Expense_Budget_Funding_-_All_Source_20250923.csv"

nycem <- readr::read_csv(file_path, show_col_types = FALSE)
```

### Filter to NYCEM and select relevant columns

```{r filter-select}
agency_name <- "NEW YORK CITY EMERGENCY MANAGEMENT"  # <-- change this if needed

# Columns to keep (matching notebook)
new_columns <- c(
  "Publication Date",
  "Fiscal Year",
  "Agency Number",
  "Agency Name",
  "Personal Service/Other Than Personal Service Indicator",
  "Total Financial Plan Amount",
  "Total Adopted Budget Amount",
  "Total Current Budget Amount",
  "Federal Funds Financial Plan Amount",
  "Federal Funds Adopted Budget Amount",
  "Federal Funds Current Budget Amount",
  "State  Funds Financial Plan Amount",
  "State Funds Adopted Budget Amount",
  "State Funds Current Budget Amount ",
  "City Funds Financial Plan Amount",
  "City Funds Adopted Budget Amount",
  "City Funds Current Budget Amount"
)

# Filter to agency 017 and sort by Publication Date desc
filtered <- nycem %>%
  dplyr::filter(`Agency Number` == "017") %>%
  dplyr::arrange(dplyr::desc(`Publication Date`))

# Subset
nycem2 <- filtered %>% dplyr::select(dplyr::any_of(new_columns))

# Parse Publication Date (format YYYYMMDD)
nycem2 <- nycem2 %>% dplyr::mutate(`Publication Date` = lubridate::ymd(as.character(`Publication Date`)))

# Filter for June (month == 6)
june_nycem <- nycem2 %>% dplyr::filter(lubridate::month(`Publication Date`) == 6)

spending <- function(data, type) {
  data %>% dplyr::filter(`Personal Service/Other Than Personal Service Indicator` == type)
}

spending_types <- list(
  june_nycem_p = spending(june_nycem, "P"),
  june_nycem_o = spending(june_nycem, "O")
)
```

### Plot helper: totals vs federal vs city (Current)

```{r helpers-grapher}
# Save and show a line plot of totals, federal, city against years
grapher <- function(data, totals, title, filename, legend_loc = "right") {
  df <- data %>% dplyr::mutate(year = lubridate::year(`Publication Date`))

  p <- ggplot(df, aes(x = year)) +
    theme_minimal(base_family = "mono") +
    theme(
      panel.background = element_rect(fill = "lightgrey", colour = NA),
      plot.background = element_rect(fill = "white", colour = NA)
    ) +
    geom_line(aes(y = .data[[totals]], colour = totals), linewidth = 1) +
    geom_point(aes(y = .data[[totals]], colour = totals), size = 2) +
    geom_line(aes(y = `Federal Funds Current Budget Amount`, colour = "Federal Funds Current Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `Federal Funds Current Budget Amount`, colour = "Federal Funds Current Budget Amount"), size = 2) +
    geom_line(aes(y = `City Funds Current Budget Amount`, colour = "City Funds Current Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `City Funds Current Budget Amount`, colour = "City Funds Current Budget Amount"), size = 2) +
    labs(title = title, x = "Year", y = "Spending (Dollars)", colour = NULL) +
    scale_colour_manual(values = setNames(
      c("#007FFF", "#FF6F00", "#FF0000"),
      c(totals, "Federal Funds Current Budget Amount", "City Funds Current Budget Amount")
    )) +
    scale_x_continuous(breaks = sort(unique(df$year))) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    guides(colour = guide_legend(position = legend_loc))

  print(p)
  ggsave(filename, p, width = 10, height = 6, dpi = 300)
}
```

### Reproduce current budget plots

```{r run-current-plots}
# Personal Service (P)
grapher(
  spending_types$june_nycem_p,
  totals = "Total Current Budget Amount",
  title = "NYCEM: Personal Service Spending",
  filename = "nycem_personal_service_spending.png",
  legend_loc = "right"
)

# Other Than Personal Service (O)
grapher(
  spending_types$june_nycem_o,
  totals = "Total Current Budget Amount",
  title = "NYCEM: Other Than Personal Service Spending",
  filename = "nycem_other_than_personal_service_spending.png",
  legend_loc = "left"
)
```

### Plot helper: Adopted vs Current totals

```{r helpers-adopted}
adopted_grapher <- function(data, totals, title, filename) {
  df <- data %>% dplyr::mutate(year = lubridate::year(`Publication Date`))

  p <- ggplot(df, aes(x = year)) +
    theme_minimal(base_family = "mono") +
    theme(
      panel.background = element_rect(fill = "lightgrey", colour = NA),
      plot.background = element_rect(fill = "white", colour = NA)
    ) +
    geom_line(aes(y = `Total Current Budget Amount`, colour = "Total Current Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `Total Current Budget Amount`, colour = "Total Current Budget Amount"), size = 2) +
    geom_line(aes(y = .data[[totals]], colour = totals), linewidth = 1) +
    geom_point(aes(y = .data[[totals]], colour = totals), size = 2) +
    labs(title = title, x = "Year", y = "Spending (Dollars)", colour = NULL) +
    scale_colour_manual(values = setNames(
      c("#FF0000", "#007FFF"),
      c("Total Current Budget Amount", totals)
    )) +
    scale_x_continuous(breaks = sort(unique(df$year))) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    guides(colour = guide_legend(position = "right"))

  print(p)
  ggsave(filename, p, width = 10, height = 6, dpi = 300)
}

adopted_grapher(
  spending_types$june_nycem_p,
  totals = "Total Adopted Budget Amount",
  title = "NYCEM: Personal Service Spending, Adopted vs Current Totals",
  filename = "nycem_personal_service_spending_adopted.png"
)
```

### Plot helper: Federal adopted vs current

```{r helpers-federal}
adopted_grapher_federal <- function(data, adopted, title, filename) {
  df <- data %>% dplyr::mutate(year = lubridate::year(`Publication Date`))

  p <- ggplot(df, aes(x = year)) +
    theme_minimal(base_family = "mono") +
    theme(
      panel.background = element_rect(fill = "lightgrey", colour = NA),
      plot.background = element_rect(fill = "white", colour = NA)
    ) +
    geom_line(aes(y = `Federal Funds Current Budget Amount`, colour = "Federal Funds Current Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `Federal Funds Current Budget Amount`, colour = "Federal Funds Current Budget Amount"), size = 2) +
    geom_line(aes(y = .data[[adopted]], colour = adopted), linewidth = 1) +
    geom_point(aes(y = .data[[adopted]], colour = adopted), size = 2) +
    labs(title = title, x = "Year", y = "Spending (Dollars)", colour = NULL) +
    scale_colour_manual(values = setNames(
      c("#FF0000", "#007FFF"),
      c("Federal Funds Current Budget Amount", adopted)
    )) +
    scale_x_continuous(breaks = sort(unique(df$year))) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    guides(colour = guide_legend(position = "right"))

  print(p)
  ggsave(filename, p, width = 10, height = 6, dpi = 300)
}

adopted_grapher_federal(
  spending_types$june_nycem_p,
  adopted = "Federal Funds Adopted Budget Amount",
  title = "NYCEM: Personal Service Spending, Adopted vs Current Federal Funds",
  filename = "nycem_personal_service_spending_fed_adopted_current.png"
)
```

### Plot helper: City adopted vs current

```{r helpers-city}
adopted_grapher_city <- function(data, adopted, title, filename) {
  df <- data %>% dplyr::mutate(year = lubridate::year(`Publication Date`))

  p <- ggplot(df, aes(x = year)) +
    theme_minimal(base_family = "mono") +
    theme(
      panel.background = element_rect(fill = "lightgrey", colour = NA),
      plot.background = element_rect(fill = "white", colour = NA)
    ) +
    geom_line(aes(y = `City Funds Current Budget Amount`, colour = "City Funds Current Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `City Funds Current Budget Amount`, colour = "City Funds Current Budget Amount"), size = 2) +
    geom_line(aes(y = .data[[adopted]], colour = adopted), linewidth = 1) +
    geom_point(aes(y = .data[[adopted]], colour = adopted), size = 2) +
    labs(title = title, x = "Year", y = "Spending (Dollars)", colour = NULL) +
    scale_colour_manual(values = setNames(
      c("#FF0000", "#007FFF"),
      c("City Funds Current Budget Amount", adopted)
    )) +
    scale_x_continuous(breaks = sort(unique(df$year))) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    guides(colour = guide_legend(position = "left"))

  print(p)
  ggsave(filename, p, width = 10, height = 6, dpi = 300)
}

adopted_grapher_city(
  spending_types$june_nycem_p,
  adopted = "City Funds Adopted Budget Amount",
  title = "NYCEM: Personal Service Spending, Adopted vs Current City Funds",
  filename = "nycem_personal_service_spending_city_adopted_current.png"
)
```

### Plot helper: Adopted totals decomposed (federal vs city)

```{r helpers-adopted-decomposed}
adopted_grapher_decomposed <- function(data, totals, title, filename) {
  df <- data %>% dplyr::mutate(year = lubridate::year(`Publication Date`))

  p <- ggplot(df, aes(x = year)) +
    theme_minimal(base_family = "mono") +
    theme(
      panel.background = element_rect(fill = "lightgrey", colour = NA),
      plot.background = element_rect(fill = "white", colour = NA)
    ) +
    geom_line(aes(y = .data[[totals]], colour = totals), linewidth = 1) +
    geom_point(aes(y = .data[[totals]], colour = totals), size = 2) +
    geom_line(aes(y = `Federal Funds Adopted Budget Amount`, colour = "Federal Funds Adopted Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `Federal Funds Adopted Budget Amount`, colour = "Federal Funds Adopted Budget Amount"), size = 2) +
    geom_line(aes(y = `City Funds Adopted Budget Amount`, colour = "City Funds Adopted Budget Amount"), linewidth = 1) +
    geom_point(aes(y = `City Funds Adopted Budget Amount`, colour = "City Funds Adopted Budget Amount"), size = 2) +
    labs(title = title, x = "Year", y = "Spending (Dollars)", colour = NULL) +
    scale_colour_manual(values = setNames(
      c("#007FFF", "#FF6F00", "#FF0000"),
      c(totals, "Federal Funds Adopted Budget Amount", "City Funds Adopted Budget Amount")
    )) +
    scale_x_continuous(breaks = sort(unique(df$year))) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    guides(colour = guide_legend(position = "left"))

  print(p)
  ggsave(filename, p, width = 10, height = 6, dpi = 300)
}

adopted_grapher_decomposed(
  spending_types$june_nycem_p,
  totals = "Total Adopted Budget Amount",
  title = "NYCEM: Personal Service Spending, Adopted",
  filename = "nycem_personal_service_spending_adopted_decomposed.png"
)
```

### Notes
- This RMarkdown mirrors the Python notebook logic using tidyverse and ggplot2.
- PNGs are saved into the same directory as this file when knitted.
- To change the agency, update the `agency_name` variable or filter (`Agency Number`).
